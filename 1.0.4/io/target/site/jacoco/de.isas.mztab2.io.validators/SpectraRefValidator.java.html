<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SpectraRefValidator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jmztabm-io</a> &gt; <a href="index.source.html" class="el_package">de.isas.mztab2.io.validators</a> &gt; <span class="el_source">SpectraRefValidator.java</span></div><h1>SpectraRefValidator.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2019 Leibniz-Institut für Analytische Wissenschaften – ISAS – e.V..
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package de.isas.mztab2.io.validators;

import de.isas.mztab2.model.MsRun;
import de.isas.mztab2.model.Parameter;
import de.isas.mztab2.model.SpectraRef;
import java.util.LinkedList;
import java.util.List;
import java.util.Optional;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import uk.ac.ebi.pride.jmztab2.model.IMZTabColumn;
import uk.ac.ebi.pride.jmztab2.model.MZTabConstants;
import uk.ac.ebi.pride.jmztab2.utils.errors.FormatErrorType;
import uk.ac.ebi.pride.jmztab2.utils.errors.LogicalErrorType;
import uk.ac.ebi.pride.jmztab2.utils.errors.MZTabError;
import uk.ac.ebi.pride.jmztab2.utils.parser.MZTabParserContext;

/**
 *
 * @author nilshoffmann
 */
<span class="fc" id="L37">public class SpectraRefValidator implements FieldValidator&lt;List&lt;SpectraRef&gt;&gt; {</span>

    @Override
    public List&lt;MZTabError&gt; validateLine(int lineNumber, MZTabParserContext parserContext, IMZTabColumn column, String field, List&lt;SpectraRef&gt; refList) {
<span class="fc" id="L41">        List&lt;MZTabError&gt; errorList = new LinkedList&lt;&gt;();</span>
<span class="fc bfc" id="L42" title="All 2 branches covered.">        if (refList.isEmpty()) {</span>
<span class="fc" id="L43">            errorList.add(new MZTabError(FormatErrorType.SpectraRef,</span>
<span class="fc" id="L44">                    lineNumber, column.getHeader(), field));</span>
        } else {
<span class="fc bfc" id="L46" title="All 2 branches covered.">            for (SpectraRef ref : refList) {</span>
<span class="fc" id="L47">                MsRun run = ref.getMsRun();</span>
<span class="fc bfc" id="L48" title="All 2 branches covered.">                if (!Optional.ofNullable(run.getLocation()).isPresent()) {</span>
                    //As the location can be null and the field is mandatory, this is not an error, it is a warning
<span class="fc" id="L50">                    errorList.add(new MZTabError(</span>
                            LogicalErrorType.SpectraRef, lineNumber, column.
<span class="fc" id="L52">                                    getHeader(), field, &quot;ms_run[&quot; + run.</span>
<span class="fc" id="L53">                                    getId() + &quot;]-location&quot;));</span>
                } else {
<span class="fc" id="L55">                    String referenceString = ref.getReference();</span>
<span class="fc" id="L56">                    Parameter idFormatParam = run.getIdFormat();</span>
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">                    if (idFormatParam == null) {</span>
                        //fall back to scan= if nothing else is given
                    } else {
<span class="pc bpc" id="L60" title="2 of 4 branches missed.">                        if (idFormatParam.getCvAccession() == null || idFormatParam.getCvAccession().isEmpty()) {</span>
                            //user param
                        } else {
                            //cv param
<span class="fc" id="L64">                            String validationPattern = &quot;&quot;;</span>
<span class="pc bpc" id="L65" title="6 of 9 branches missed.">                            switch (idFormatParam.getCvAccession()) {</span>
                                case &quot;MS:1000768&quot;: //Thermo nativeId
                                    // &quot;controllerType=0 controllerNumber=1 scan=1&quot;
<span class="fc" id="L68">                                    validationPattern = MZTabConstants.REGEX_SPECTRA_REF_THERMO_NATIVE;</span>
<span class="fc" id="L69">                                    break;</span>
                                case &quot;MS:1000769&quot;: //Waters nativeId
                                    // &quot;function=0 process=0 scan=0&quot;
<span class="nc" id="L72">                                    validationPattern = MZTabConstants.REGEX_SPECTRA_REF_WATERS_NATIVE;</span>
<span class="nc" id="L73">                                    break;</span>
                                case &quot;MS:1000770&quot;: //WIFF nativeId
                                    // &quot;sample=0 period=0 cycle=0 experiment=0&quot;
<span class="nc" id="L76">                                    validationPattern = MZTabConstants.REGEX_SPECTRA_REF_WIFF_NATIVE;</span>
<span class="nc" id="L77">                                    break;</span>
                                case &quot;MS:1000774&quot;: //multiple peak list nativeID, MGF, PKL, merged DTA
                                    // index=0
<span class="nc" id="L80">                                    validationPattern = MZTabConstants.REGEX_SPECTRA_REF_INDEX;</span>
<span class="nc" id="L81">                                    break;</span>
                                case &quot;MS:1000773&quot;: // Bruker FID nativeId
                                case &quot;MS:1000775&quot;: //file single peak list nativeId
                                    //file=xsd:IDREF
<span class="nc" id="L85">                                    validationPattern = MZTabConstants.REGEX_SPECTRA_REF_FILE;</span>
<span class="nc" id="L86">                                    break;</span>
                                case &quot;MS:1000777&quot;: // spectrum identifier nativeId
                                    //spectrum=0
<span class="nc" id="L89">                                    validationPattern = MZTabConstants.REGEX_SPECTRA_REF_SPECTRUM;</span>
<span class="nc" id="L90">                                    break;</span>
                                case &quot;MS:1001530&quot;: // mzML unique identifier
                                    //xsd:string
<span class="nc" id="L93">                                    validationPattern = MZTabConstants.REGEX_SPECTRA_REF_MZML_UNIQUE;</span>
<span class="nc" id="L94">                                    break;</span>
                                //scan instances below
                                case &quot;MS:1000771&quot;: //Bruker/Agilent YEP nativeId
                                case &quot;MS:1000772&quot;: //Bruker BAF nativeId    
                                case &quot;MS:1000776&quot;: //mzML scan ref
                                    // scan=0
<span class="fc" id="L100">                                    validationPattern = MZTabConstants.REGEX_SPECTRA_REF_SCAN;</span>
<span class="fc" id="L101">                                    break;</span>
                                default:
                                    //As the given idFormat may be unsupported by this validator, we issue a warning!
<span class="fc" id="L104">                                    errorList.add(new MZTabError(</span>
                                            LogicalErrorType.SpectraIdFormatNotSupported, lineNumber, referenceString, column.
<span class="fc" id="L106">                                                    getHeader()));</span>
                            }
<span class="fc bfc" id="L108" title="All 2 branches covered.">                            if(!validationPattern.isEmpty()) {</span>
<span class="fc" id="L109">                                Optional&lt;MZTabError&gt; error = validatePattern(Pattern.compile(validationPattern), referenceString, lineNumber, column, field, run);</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">                                if (error.isPresent()) {</span>
<span class="fc" id="L111">                                    errorList.add(error.get());</span>
                                }
                            }
                        }
                    }
                }
<span class="fc" id="L117">            }</span>
        }
<span class="fc" id="L119">        return errorList;</span>
    }

    protected Optional&lt;MZTabError&gt; validatePattern(Pattern pattern, String reference, int lineNumber, IMZTabColumn column, String field, MsRun run) {
<span class="fc" id="L123">        Matcher matcher = pattern.matcher(reference);</span>

<span class="fc bfc" id="L125" title="All 2 branches covered.">        if (matcher.find()) {</span>
<span class="fc" id="L126">            return Optional.empty();</span>
        }
<span class="fc" id="L128">        return Optional.of(new MZTabError(</span>
                LogicalErrorType.SpectraIdFormatNotValid,
                lineNumber,
                reference,
<span class="fc" id="L132">                column.getHeader(),</span>
<span class="fc" id="L133">                pattern.toString()</span>
            )
        );
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>