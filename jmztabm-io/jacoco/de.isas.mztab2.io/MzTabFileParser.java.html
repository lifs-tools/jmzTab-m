<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MzTabFileParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">jmztabm-io</a> &gt; <a href="index.source.html" class="el_package">de.isas.mztab2.io</a> &gt; <span class="el_source">MzTabFileParser.java</span></div><h1>MzTabFileParser.java</h1><pre class="source lang-java linenums">/* 
 * Copyright 2018 Leibniz-Institut für Analytische Wissenschaften – ISAS – e.V..
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package de.isas.mztab2.io;

import de.isas.mztab2.model.ColumnParameterMapping;
import de.isas.mztab2.model.Comment;
import de.isas.mztab2.model.Metadata;
import de.isas.mztab2.model.MsRun;
import de.isas.mztab2.model.MzTab;
import de.isas.mztab2.model.SmallMoleculeEvidence;
import de.isas.mztab2.model.SmallMoleculeFeature;
import de.isas.mztab2.model.SmallMoleculeSummary;
import java.io.*;
import java.net.URI;
import java.net.URL;
import java.util.Collection;
import java.util.Collections;
import java.util.HashSet;
import java.util.Optional;
import java.util.Set;
import java.util.SortedMap;
import java.util.TreeMap;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collectors;
import java.util.zip.GZIPInputStream;
import uk.ac.ebi.pride.jmztab2.model.IMZTabColumn;
import uk.ac.ebi.pride.jmztab2.model.MZTabColumnFactory;
import static uk.ac.ebi.pride.jmztab2.model.MZTabConstants.NEW_LINE;
import static uk.ac.ebi.pride.jmztab2.model.MZTabConstants.REGEX_DEFAULT_RELIABILITY;
import static uk.ac.ebi.pride.jmztab2.model.MZTabConstants.TAB;
import uk.ac.ebi.pride.jmztab2.model.MZTabStringUtils;
import uk.ac.ebi.pride.jmztab2.model.Section;
import static uk.ac.ebi.pride.jmztab2.utils.MZTabProperties.*;
import uk.ac.ebi.pride.jmztab2.utils.errors.FormatErrorType;
import uk.ac.ebi.pride.jmztab2.utils.errors.LogicalErrorType;
import uk.ac.ebi.pride.jmztab2.utils.errors.MZTabError;
import uk.ac.ebi.pride.jmztab2.utils.errors.MZTabErrorList;
import uk.ac.ebi.pride.jmztab2.utils.errors.MZTabErrorOverflowException;
import uk.ac.ebi.pride.jmztab2.utils.errors.MZTabErrorType;
import uk.ac.ebi.pride.jmztab2.utils.errors.MZTabException;
import uk.ac.ebi.pride.jmztab2.utils.parser.COMLineParser;
import uk.ac.ebi.pride.jmztab2.utils.parser.MTDLineParser;
import uk.ac.ebi.pride.jmztab2.utils.parser.MZTabParserContext;
import uk.ac.ebi.pride.jmztab2.utils.parser.PositionMapping;
import uk.ac.ebi.pride.jmztab2.utils.parser.SEHLineParser;
import uk.ac.ebi.pride.jmztab2.utils.parser.SFHLineParser;
import uk.ac.ebi.pride.jmztab2.utils.parser.SMELineParser;
import uk.ac.ebi.pride.jmztab2.utils.parser.SMFLineParser;
import uk.ac.ebi.pride.jmztab2.utils.parser.SMHLineParser;
import uk.ac.ebi.pride.jmztab2.utils.parser.SMLLineParser;

/**
 *
 * MZTabFileParser provides reading functionality of the mzTab file. During the
 * parsing process, minimal integrity checks are preformed.
 *
 * @author qingwei
 * @author nilshoffmann
 * 
 * @since 21/02/13
 *
 */
public class MzTabFileParser {

    private MzTab mzTabFile;
    private URI tabFile;

    private MZTabErrorList errorList;
    private MZTabParserContext context;

    /**
     * Create a new {@code MZTabFileParser} for the given file.
     *
     * @param tabFile the MZTab file. The file SHOULD not be null and MUST exist
     * @throws java.lang.IllegalArgumentException if the provided argument in
     * invalid.
     */
    public MzTabFileParser(File tabFile) throws IllegalArgumentException {
<span class="fc" id="L93">        this(tabFile.toURI());</span>
<span class="fc" id="L94">    }</span>

    /**
     * Create a new {@code MZTabFileParser} for the given file URI.
     *
     * @param tabFileUri the MZTab file URI. The file SHOULD not be null and
     * MUST exist {@link uk.ac.ebi.pride.jmztab2.utils.errors.MZTabErrorList}
     * return by
     * {@link de.isas.mztab2.io.MzTabFileParser#getErrorList()}
     * @throws java.lang.IllegalArgumentException if the provided argument in
     * invalid.
     */
<span class="fc" id="L106">    public MzTabFileParser(URI tabFileUri) throws IllegalArgumentException {</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">        if (tabFileUri == null) {</span>
<span class="nc" id="L108">            throw new IllegalArgumentException(</span>
                &quot;MZTab file uri must not be null!&quot;);
        }
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">        if ((&quot;file&quot;.equals(tabFileUri.getScheme()) &amp;&amp; !new File(tabFileUri).</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">            exists())) {</span>
<span class="nc" id="L113">            throw new IllegalArgumentException(&quot;MZTab File URI &quot; + tabFileUri.</span>
<span class="nc" id="L114">                toASCIIString() + &quot; does not exist!&quot;);</span>
        }

<span class="fc" id="L117">        this.tabFile = tabFileUri;</span>
<span class="fc" id="L118">    }</span>

    /**
     * Create a new {@code MZTabParserContext} and {@code MZTabErrorList} for
     * the given file URI. Parsing output and errors are written to the provided
     * {@link java.io.OutputStream}.
     *
     * @param out the output stream for parsing messages
     * @param level the minimum error level to report errors for
     * @param maxErrorCount the maximum number of errors to report in the
     * {@link uk.ac.ebi.pride.jmztab2.utils.errors.MZTabErrorList} return by
     * {@link de.isas.mztab2.io.MzTabFileParser#getErrorList()}
     * @return the error list
     * @throws java.io.IOException if any io related errors occur.
     */
    public MZTabErrorList parse(OutputStream out, MZTabErrorType.Level level,
        int maxErrorCount) throws IOException {
        try {
<span class="fc" id="L136">            context = new MZTabParserContext();</span>
<span class="fc" id="L137">            errorList = new MZTabErrorList(level, maxErrorCount);</span>
<span class="fc" id="L138">            check();</span>
<span class="fc" id="L139">            refine();</span>
<span class="nc" id="L140">        } catch (MZTabException e) {</span>
<span class="nc" id="L141">            out.write(e.getMessage().getBytes());</span>
<span class="nc" id="L142">            try (PrintStream ps = new PrintStream(out)) {</span>
<span class="nc" id="L143">                e.printStackTrace(ps);</span>
            }
<span class="nc" id="L145">            errorList.add(e.getError());</span>
<span class="nc" id="L146">        } catch (MZTabErrorOverflowException e) {</span>
<span class="nc" id="L147">            try (PrintStream ps = new PrintStream(out)) {</span>
<span class="nc" id="L148">                e.printStackTrace(ps);</span>
            }
<span class="nc" id="L150">            out.write(e.getMessage().getBytes());</span>
<span class="pc" id="L151">        }</span>

<span class="fc" id="L153">        errorList.print(out);</span>
<span class="fc bfc" id="L154" title="All 4 branches covered.">        if (mzTabFile != null &amp;&amp; errorList.isEmpty()) {</span>
<span class="fc" id="L155">            out.write(</span>
                (&quot;No structural or logical errors in &quot; + tabFile + &quot; file!&quot; + NEW_LINE).
<span class="fc" id="L157">                    getBytes());</span>
        }
<span class="fc" id="L159">        return errorList;</span>
    }

    /**
     * Create a new {@code MZTabParserContext} and {@code MZTabErrorList} for
     * the given file URI. Parsing output and errors are written to the provided
     * {@link java.io.OutputStream}. Reports up to
     * {@link uk.ac.ebi.pride.jmztab2.utils.MZTabProperties#MAX_ERROR_COUNT}
     * errors.
     *
     * @param out the output stream for parsing messages
     * @param level the minimum error level to report errors for
     * @return the error list
     * @throws java.io.IOException if any io related errors occur.
     */
    public MZTabErrorList parse(OutputStream out, MZTabErrorType.Level level) throws IOException {
<span class="nc" id="L175">        return parse(out, level, MAX_ERROR_COUNT);</span>
    }

    /**
     * Create a new {@code MZTabParserContext} and {@code MZTabErrorList} for
     * the given file URI. Parsing output and errors are written to the provided
     * {@link java.io.OutputStream}. Reports up to
     * {@link uk.ac.ebi.pride.jmztab2.utils.MZTabProperties#MAX_ERROR_COUNT}
     * errors on level
     * {@link uk.ac.ebi.pride.jmztab2.utils.MZTabProperties#LEVEL}.
     *
     * @param out the output stream for parsing messages
     * @return the error list
     * @throws java.io.IOException if any io related errors occur.
     */
    public MZTabErrorList parse(OutputStream out) throws IOException {
<span class="nc" id="L191">        return parse(out, LEVEL, MAX_ERROR_COUNT);</span>
    }

    /**
     * &lt;p&gt;
     * Getter for the field &lt;code&gt;errorList&lt;/code&gt;.&lt;/p&gt;
     *
     * @return a {@link uk.ac.ebi.pride.jmztab2.utils.errors.MZTabErrorList}
     * object.
     */
    public MZTabErrorList getErrorList() {
<span class="fc" id="L202">        return errorList;</span>
    }

    private Section getSection(String line) {
<span class="fc" id="L206">        String[] items = line.split(&quot;\\s*&quot; + TAB + &quot;\\s*&quot;);</span>
<span class="fc" id="L207">        String section = items[0].trim();</span>
<span class="fc" id="L208">        return Section.findSection(section);</span>
    }

    private BufferedReader readFile(URI tabFile) throws IOException {
        BufferedReader reader;

        InputStream is;
<span class="fc" id="L215">        File file = new File(tabFile);</span>
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">        if (file.isFile()) {</span>
<span class="fc" id="L217">            is = new FileInputStream(file);</span>
        } else {
<span class="nc" id="L219">            URL tabFileUrl = tabFile.toURL();</span>
<span class="nc" id="L220">            is = tabFileUrl.openStream();</span>
        }
<span class="fc" id="L222">        if (tabFile.getPath().</span>
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">            endsWith(&quot;.gz&quot;)) {</span>
<span class="nc" id="L224">            reader = new BufferedReader(new InputStreamReader(</span>
                new GZIPInputStream(is), ENCODE));
        } else {
<span class="fc" id="L227">            reader = new BufferedReader(new InputStreamReader(</span>
                is, ENCODE));
        }

<span class="fc" id="L231">        return reader;</span>
    }

    private String subString(String source) {
<span class="nc" id="L235">        int length = 20;</span>

<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (length &gt;= source.length()) {</span>
<span class="nc" id="L238">            return source;</span>
        } else {
<span class="nc" id="L240">            return source.substring(0, length - 1) + &quot;...&quot;;</span>
        }
    }

    /**
     * refine all MZTabFile consistency correct.
     */
    private void refine() throws MZTabException, MZTabErrorOverflowException {
<span class="fc bfc" id="L248" title="All 2 branches covered.">        if (mzTabFile == null) {</span>
<span class="fc" id="L249">            return;</span>
        }

<span class="fc" id="L252">        Metadata metadata = mzTabFile.getMetadata();</span>

        //If ms_run[1-n]-hash is present,  ms_run[1-n]-hash_method SHOULD also be present
<span class="fc bfc" id="L255" title="All 2 branches covered.">        for (MsRun msRun : metadata.getMsRun()) {</span>
<span class="pc bpc" id="L256" title="1 of 4 branches missed.">            if (msRun.getHash() != null &amp;&amp; msRun.getHashMethod() == null) {</span>
<span class="nc" id="L257">                throw new MZTabException(new MZTabError(</span>
                    LogicalErrorType.MsRunHashMethodNotDefined, -1, msRun.
<span class="nc" id="L259">                        getId().</span>
<span class="nc" id="L260">                        toString()));</span>
            }
<span class="fc" id="L262">        }</span>
<span class="fc" id="L263">    }</span>

    /**
     * Query {@link MZTabErrorList} to check exist errors or not.
     *
     * @throws java.io.IOException
     * @throws uk.ac.ebi.pride.jmztab.utils.errors.MZTabException during parsing
     * of metadata,
     * protein/peptide/small_molecule/small_molecule_feature/small_molecule_evidence
     * header lines, if there exist any errors.
     * @throws uk.ac.ebi.pride.jmztab.utils.errors.MZTabErrorOverflowException
     * when too many errors are detected, as defined by the mztab.properties
     * file mztab.max_error_count parameter.
     */
    private void check() throws IOException, MZTabException, MZTabErrorOverflowException {
<span class="fc" id="L278">        COMLineParser comParser = new COMLineParser(context);</span>
<span class="fc" id="L279">        MTDLineParser mtdParser = new MTDLineParser(context);</span>
<span class="fc" id="L280">        SMHLineParser smhParser = null;</span>
<span class="fc" id="L281">        SMLLineParser smlParser = null;</span>
<span class="fc" id="L282">        SFHLineParser sfhParser = null;</span>
<span class="fc" id="L283">        SMFLineParser smfParser = null;</span>
<span class="fc" id="L284">        SEHLineParser sehParser = null;</span>
<span class="fc" id="L285">        SMELineParser smeParser = null;</span>

<span class="fc" id="L287">        SortedMap&lt;Integer, Comment&gt; commentMap = new TreeMap&lt;&gt;();</span>
<span class="fc" id="L288">        SortedMap&lt;Integer, SmallMoleculeSummary&gt; smallMoleculeSummaryMap = new TreeMap&lt;&gt;();</span>
<span class="fc" id="L289">        SortedMap&lt;Integer, SmallMoleculeFeature&gt; smallMoleculeFeatureMap = new TreeMap&lt;&gt;();</span>
<span class="fc" id="L290">        SortedMap&lt;Integer, SmallMoleculeEvidence&gt; smallMoleculeEvidenceMap = new TreeMap&lt;&gt;();</span>

<span class="fc" id="L292">        PositionMapping smlPositionMapping = null;</span>
<span class="fc" id="L293">        PositionMapping smfPositionMapping = null;</span>
<span class="fc" id="L294">        PositionMapping smePositionMapping = null;</span>

        String line;
<span class="fc" id="L297">        int highWaterMark = 1;</span>
<span class="fc" id="L298">        int lineNumber = 0;</span>
        Section section;
<span class="fc" id="L300">        try (BufferedReader reader = readFile(tabFile)) {</span>
<span class="fc bfc" id="L301" title="All 2 branches covered.">            while ((line = reader.readLine()) != null) {</span>
                try {
<span class="fc" id="L303">                    lineNumber++;</span>

<span class="fc bfc" id="L305" title="All 2 branches covered.">                    if (MZTabStringUtils.isEmpty(line)) {</span>
<span class="fc" id="L306">                        continue;</span>
                    }

<span class="fc bfc" id="L309" title="All 2 branches covered.">                    if (line.startsWith(Section.Comment.getPrefix())) {</span>
<span class="fc" id="L310">                        comParser.parse(lineNumber, line, errorList);</span>
<span class="fc" id="L311">                        commentMap.put(lineNumber, comParser.getComment());</span>
<span class="fc" id="L312">                        continue;</span>
                    }

<span class="fc" id="L315">                    section = getSection(line);</span>
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">                    if (section == null) {</span>
<span class="nc" id="L317">                        MZTabError sectionNullError = new MZTabError(</span>
                            FormatErrorType.LinePrefix, lineNumber,
<span class="nc" id="L319">                            subString(line));</span>
<span class="nc" id="L320">                        throw new MZTabException(sectionNullError);</span>
                    }
<span class="pc bpc" id="L322" title="1 of 2 branches missed.">                    if (section.getLevel() &lt; highWaterMark) {</span>
<span class="nc" id="L323">                        Section currentSection = Section.findSection(</span>
                            highWaterMark);
<span class="nc" id="L325">                        MZTabError sectionLineOrderError = new MZTabError(</span>
                            LogicalErrorType.LineOrder, lineNumber,
<span class="nc" id="L327">                            currentSection.getName(), section.getName());</span>
<span class="nc" id="L328">                        throw new MZTabException(sectionLineOrderError);</span>
                    }

<span class="fc" id="L331">                    highWaterMark = section.getLevel();</span>

<span class="pc bpc" id="L333" title="1 of 8 branches missed.">                    switch (highWaterMark) {</span>
                        case 1:
                            // metadata section.
<span class="fc" id="L336">                            mtdParser.parse(lineNumber, line, errorList);</span>
<span class="fc" id="L337">                            break;</span>
                        case 8:
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">                            if (smhParser != null) {</span>
<span class="nc" id="L340">                                MZTabError error = new MZTabError(</span>
                                    LogicalErrorType.HeaderLine,
<span class="nc" id="L342">                                    lineNumber, subString(line));</span>
                                // header line only display once!
<span class="nc" id="L344">                                throw new MZTabException(error);</span>
                            }

                            // small molecule header section
<span class="fc" id="L348">                            smhParser = new SMHLineParser(context, mtdParser.</span>
<span class="fc" id="L349">                                getMetadata());</span>
<span class="fc" id="L350">                            smhParser.parse(lineNumber, line, errorList);</span>
<span class="fc" id="L351">                            smlPositionMapping = new PositionMapping(smhParser.</span>
<span class="fc" id="L352">                                getFactory(), line);</span>

                            // tell system to continue check small molecule data line.
<span class="fc" id="L355">                            highWaterMark = 9;</span>
<span class="fc" id="L356">                            break;</span>
                        case 9:
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">                            if (smhParser == null) {</span>
                                // header line should be check first.
<span class="nc" id="L360">                                throw new MZTabException(new MZTabError(</span>
                                    LogicalErrorType.NoHeaderLine,
<span class="nc" id="L362">                                    lineNumber, subString(line)));</span>
                            }

<span class="fc bfc" id="L365" title="All 2 branches covered.">                            if (smlParser == null) {</span>
<span class="fc" id="L366">                                smlParser = new SMLLineParser(context,</span>
                                    smhParser.
<span class="fc" id="L368">                                        getFactory(),</span>
<span class="fc" id="L369">                                    smlPositionMapping, mtdParser.getMetadata(),</span>
                                    errorList);
                            }
<span class="fc" id="L372">                            smlParser.parse(lineNumber, line, errorList);</span>
<span class="fc" id="L373">                            smallMoleculeSummaryMap.put(lineNumber, smlParser.</span>
<span class="fc" id="L374">                                getRecord());</span>

<span class="fc" id="L376">                            break;</span>
                        case 10:
<span class="pc bpc" id="L378" title="1 of 2 branches missed.">                            if (sfhParser != null) {</span>
                                // header line only display once!
<span class="nc" id="L380">                                throw new MZTabException(new MZTabError(</span>
                                    LogicalErrorType.HeaderLine,
<span class="nc" id="L382">                                    lineNumber, subString(line)));</span>
                            }

                            // small molecule header section
<span class="fc" id="L386">                            sfhParser = new SFHLineParser(context, mtdParser.</span>
<span class="fc" id="L387">                                getMetadata());</span>
<span class="fc" id="L388">                            sfhParser.parse(lineNumber, line, errorList);</span>
<span class="fc" id="L389">                            smfPositionMapping = new PositionMapping(sfhParser.</span>
<span class="fc" id="L390">                                getFactory(), line);</span>

                            // tell system to continue check small molecule data line.
<span class="fc" id="L393">                            highWaterMark = 11;</span>
<span class="fc" id="L394">                            break;</span>
                        case 11:
<span class="pc bpc" id="L396" title="1 of 2 branches missed.">                            if (sfhParser == null) {</span>
                                // header line should be check first.
<span class="nc" id="L398">                                throw new MZTabException(new MZTabError(</span>
                                    LogicalErrorType.NoHeaderLine,
<span class="nc" id="L400">                                    lineNumber, subString(line)));</span>
                            }

<span class="fc bfc" id="L403" title="All 2 branches covered.">                            if (smfParser == null) {</span>
<span class="fc" id="L404">                                smfParser = new SMFLineParser(context,</span>
                                    sfhParser.
<span class="fc" id="L406">                                        getFactory(),</span>
<span class="fc" id="L407">                                    smfPositionMapping, mtdParser.getMetadata(),</span>
                                    errorList);
                            }
<span class="fc" id="L410">                            smfParser.parse(lineNumber, line, errorList);</span>
<span class="fc" id="L411">                            smallMoleculeFeatureMap.put(lineNumber, smfParser.</span>
<span class="fc" id="L412">                                getRecord());</span>

<span class="fc" id="L414">                            break;</span>
                        case 12:
<span class="pc bpc" id="L416" title="1 of 2 branches missed.">                            if (sehParser != null) {</span>
                                // header line only display once!
<span class="nc" id="L418">                                throw new MZTabException(new MZTabError(</span>
                                    LogicalErrorType.HeaderLine,
<span class="nc" id="L420">                                    lineNumber, subString(line)));</span>
                            }

                            // small molecule header section
<span class="fc" id="L424">                            sehParser = new SEHLineParser(context, mtdParser.</span>
<span class="fc" id="L425">                                getMetadata());</span>
<span class="fc" id="L426">                            sehParser.parse(lineNumber, line, errorList);</span>
<span class="fc" id="L427">                            smePositionMapping = new PositionMapping(sehParser.</span>
<span class="fc" id="L428">                                getFactory(), line);</span>

                            // tell system to continue check small molecule data line.
<span class="fc" id="L431">                            highWaterMark = 13;</span>
<span class="fc" id="L432">                            break;</span>
                        case 13:
<span class="pc bpc" id="L434" title="1 of 2 branches missed.">                            if (sehParser == null) {</span>
                                // header line should be check first.
<span class="nc" id="L436">                                throw new MZTabException(new MZTabError(</span>
                                    LogicalErrorType.NoHeaderLine,
<span class="nc" id="L438">                                    lineNumber, subString(line)));</span>
                            }

<span class="fc bfc" id="L441" title="All 2 branches covered.">                            if (smeParser == null) {</span>
<span class="fc" id="L442">                                smeParser = new SMELineParser(context,</span>
                                    sehParser.
<span class="fc" id="L444">                                        getFactory(),</span>
<span class="fc" id="L445">                                    smePositionMapping, mtdParser.getMetadata(),</span>
                                    errorList);
                            }
<span class="fc" id="L448">                            smeParser.parse(lineNumber, line, errorList);</span>
<span class="fc" id="L449">                            smallMoleculeEvidenceMap.put(lineNumber, smeParser.</span>
<span class="fc" id="L450">                                getRecord());</span>

<span class="fc" id="L452">                            break;</span>
                        default:
<span class="nc" id="L454">                            throw new IllegalArgumentException(</span>
                                &quot;Unknown section level &quot; + highWaterMark);
                    }
<span class="nc" id="L457">                } catch (NullPointerException npe) {</span>
<span class="nc" id="L458">                    throw new MZTabException(new MZTabError(</span>
                        LogicalErrorType.NULL,
<span class="nc" id="L460">                        lineNumber, subString(line)), npe);</span>
<span class="fc" id="L461">                }</span>
            }

        }

<span class="fc" id="L466">        mtdParser.refineNormalMetadata();</span>

<span class="fc bfc" id="L468" title="All 2 branches covered.">        if (errorList.isEmpty()) {</span>
<span class="fc" id="L469">            mzTabFile = new MzTab();</span>
<span class="fc" id="L470">            mzTabFile.metadata(mtdParser.getMetadata());</span>
<span class="fc bfc" id="L471" title="All 2 branches covered.">            for (Integer id : commentMap.keySet()) {</span>
<span class="fc" id="L472">                mzTabFile.addCommentItem(commentMap.get(id));</span>
<span class="fc" id="L473">            }</span>

<span class="fc bfc" id="L475" title="All 2 branches covered.">            if (smallMoleculeSummaryMap.isEmpty()) {</span>
<span class="fc" id="L476">                errorList.add(new MZTabError(</span>
                    LogicalErrorType.NoSmallMoleculeSummarySection, -1));
            }
<span class="fc bfc" id="L479" title="All 2 branches covered.">            if (smlParser != null) {</span>

<span class="fc bfc" id="L481" title="All 2 branches covered.">                for (Integer id : smallMoleculeSummaryMap.keySet()) {</span>
<span class="fc" id="L482">                    mzTabFile.addSmallMoleculeSummaryItem(</span>
<span class="fc" id="L483">                        smallMoleculeSummaryMap.get(</span>
                            id));
<span class="fc" id="L485">                }</span>
                //check that reliability values are correct
<span class="fc" id="L487">                if (mzTabFile.getMetadata().</span>
<span class="pc bpc" id="L488" title="1 of 2 branches missed.">                    getSmallMoleculeIdentificationReliability() == null) {</span>
<span class="nc" id="L489">                    Pattern p = Pattern.compile(REGEX_DEFAULT_RELIABILITY);</span>
<span class="nc bnc" id="L490" title="All 2 branches missed.">                    for (SmallMoleculeSummary smi : mzTabFile.</span>
<span class="nc" id="L491">                        getSmallMoleculeSummary()) {</span>
<span class="nc" id="L492">                        String reliability = smi.getReliability();</span>
<span class="nc" id="L493">                        Matcher matcher = p.matcher(reliability);</span>
<span class="nc bnc" id="L494" title="All 2 branches missed.">                        if (!matcher.matches()) {</span>
<span class="nc" id="L495">                            errorList.add(new MZTabError(</span>
                                FormatErrorType.RegexMismatch, -1,
                                SmallMoleculeSummary.Properties.reliability.
<span class="nc" id="L498">                                    getPropertyName(), reliability,</span>
                                MzTab.Properties.smallMoleculeSummary.
<span class="nc" id="L500">                                    getPropertyName(), &quot;&quot; + smi.getSmlId(),</span>
                                REGEX_DEFAULT_RELIABILITY));
                        }
<span class="nc" id="L503">                    }</span>
                }
<span class="fc" id="L505">                checkColunitMapping(smhParser.getFactory(), Optional.ofNullable(</span>
                    mzTabFile.
<span class="fc" id="L507">                        getMetadata().</span>
<span class="fc" id="L508">                        getColunitSmallMolecule()),</span>
                    Metadata.Properties.colunitSmallMolecule,
                    MzTab.Properties.smallMoleculeSummary);
            }

<span class="fc bfc" id="L513" title="All 2 branches covered.">            if (smallMoleculeFeatureMap.isEmpty() &amp;&amp; !smallMoleculeSummaryMap.</span>
<span class="pc bpc" id="L514" title="1 of 2 branches missed.">                isEmpty()) {</span>
<span class="nc" id="L515">                errorList.add(new MZTabError(</span>
                    LogicalErrorType.NoSmallMoleculeFeatureSection, -1));
            }
<span class="fc bfc" id="L518" title="All 2 branches covered.">            if (smfParser != null) {</span>
<span class="fc bfc" id="L519" title="All 2 branches covered.">                for (Integer id : smallMoleculeFeatureMap.keySet()) {</span>
<span class="fc" id="L520">                    SmallMoleculeFeature smf</span>
<span class="fc" id="L521">                        = smallMoleculeFeatureMap.get(</span>
                            id);
<span class="fc" id="L523">                    mzTabFile.addSmallMoleculeFeatureItem(smf);</span>
<span class="fc" id="L524">                }</span>
<span class="pc bpc" id="L525" title="1 of 2 branches missed.">                if (smallMoleculeFeatureMap.size() &gt; 0 &amp;&amp; mzTabFile.</span>
<span class="fc" id="L526">                    getMetadata().</span>
<span class="pc bpc" id="L527" title="1 of 2 branches missed.">                    getSmallMoleculeFeatureQuantificationUnit() == null) {</span>
<span class="nc" id="L528">                    errorList.add(new MZTabError(</span>
                        LogicalErrorType.NoSmallMoleculeFeatureQuantificationUnit,
                        -1));
                }
<span class="fc" id="L532">                checkColunitMapping(sfhParser.getFactory(), Optional.ofNullable(</span>
                    mzTabFile.
<span class="fc" id="L534">                        getMetadata().</span>
<span class="fc" id="L535">                        getColunitSmallMoleculeFeature()),</span>
                    Metadata.Properties.colunitSmallMoleculeFeature,
                    MzTab.Properties.smallMoleculeFeature);
            }
<span class="fc bfc" id="L539" title="All 2 branches covered.">            if (smallMoleculeEvidenceMap.isEmpty() &amp;&amp; !smallMoleculeSummaryMap.</span>
<span class="pc bpc" id="L540" title="1 of 2 branches missed.">                isEmpty()) {</span>
<span class="nc" id="L541">                errorList.add(new MZTabError(</span>
                    LogicalErrorType.NoSmallMoleculeEvidenceSection, -1));
            }
<span class="fc bfc" id="L544" title="All 2 branches covered.">            if (smeParser != null) {</span>
<span class="fc bfc" id="L545" title="All 2 branches covered.">                for (Integer id : smallMoleculeEvidenceMap.keySet()) {</span>
<span class="fc" id="L546">                    mzTabFile.addSmallMoleculeEvidenceItem(</span>
<span class="fc" id="L547">                        smallMoleculeEvidenceMap.get(</span>
                            id));
<span class="fc" id="L549">                }</span>
<span class="fc" id="L550">                checkColunitMapping(sehParser.getFactory(), Optional.ofNullable(</span>
                    mzTabFile.
<span class="fc" id="L552">                        getMetadata().</span>
<span class="fc" id="L553">                        getColunitSmallMoleculeEvidence()),</span>
                    Metadata.Properties.colunitSmallMoleculeEvidence,
                    MzTab.Properties.smallMoleculeEvidence
                );
            }
            //check ID refs, starting at SML level
<span class="pc bpc" id="L559" title="1 of 4 branches missed.">            if (smlParser != null &amp;&amp; smfParser != null) {</span>
<span class="fc bfc" id="L560" title="All 2 branches covered.">                for (Integer id : smallMoleculeSummaryMap.keySet()) {</span>
<span class="fc" id="L561">                    SmallMoleculeSummary sms = smallMoleculeSummaryMap.get(id);</span>
<span class="fc" id="L562">                    Set&lt;Integer&gt; smfIdRefs = new HashSet&lt;&gt;(sms.getSmfIdRefs());</span>
<span class="fc" id="L563">                    Set&lt;Integer&gt; definedIds = smallMoleculeFeatureMap.values().</span>
<span class="fc" id="L564">                        stream().</span>
<span class="fc" id="L565">                        map((t) -&gt;</span>
                        {
<span class="fc" id="L567">                            return t.getSmfId();</span>
                        }).
<span class="fc" id="L569">                        collect(Collectors.toSet());</span>
<span class="fc" id="L570">                    smfIdRefs.removeAll(definedIds);</span>
<span class="pc bpc" id="L571" title="1 of 2 branches missed.">                    if (!smfIdRefs.isEmpty()) {</span>
<span class="nc bnc" id="L572" title="All 2 branches missed.">                        for (Integer smfRefId : smfIdRefs) {</span>
                            //raise a warning about unmatched SMF id
                            //Reference id &quot;{0}&quot; for column &quot;{1}&quot; from element &quot;{2}&quot; in section &quot;{3}&quot; to section &quot;{4}&quot; must have a matching element defined.
<span class="nc" id="L575">                            errorList.add(new MZTabError(</span>
                                LogicalErrorType.UnknownRefId, -1, &quot;&quot; + smfRefId,
                                SmallMoleculeSummary.Properties.smfIdRefs.
<span class="nc" id="L578">                                    getPropertyName(), &quot;&quot; + sms.getSmlId(),</span>
                                MzTab.Properties.smallMoleculeSummary.
<span class="nc" id="L580">                                    getPropertyName(),</span>
                                MzTab.Properties.smallMoleculeFeature.
<span class="nc" id="L582">                                    getPropertyName()));</span>
<span class="nc" id="L583">                        }</span>
                    }
<span class="fc" id="L585">                }</span>
<span class="pc bpc" id="L586" title="1 of 2 branches missed.">                if (smeParser != null) {</span>
<span class="fc bfc" id="L587" title="All 2 branches covered.">                    for (Integer id : smallMoleculeFeatureMap.keySet()) {</span>
<span class="fc" id="L588">                        SmallMoleculeFeature smf = smallMoleculeFeatureMap.get(</span>
                            id);
<span class="fc" id="L590">                        Set&lt;Integer&gt; smeIdRefs = new HashSet&lt;&gt;(smf.</span>
<span class="fc" id="L591">                            getSmeIdRefs());</span>
<span class="fc" id="L592">                        Set&lt;Integer&gt; definedIds = smallMoleculeEvidenceMap.</span>
<span class="fc" id="L593">                            values().</span>
<span class="fc" id="L594">                            stream().</span>
<span class="fc" id="L595">                            map((t) -&gt;</span>
                            {
<span class="fc" id="L597">                                return t.getSmeId();</span>
                            }).
<span class="fc" id="L599">                            collect(Collectors.toSet());</span>
<span class="fc" id="L600">                        smeIdRefs.removeAll(definedIds);</span>
<span class="pc bpc" id="L601" title="1 of 2 branches missed.">                        if (!smeIdRefs.isEmpty()) {</span>
<span class="nc bnc" id="L602" title="All 2 branches missed.">                            for (Integer smeRefId : smeIdRefs) {</span>
                                //raise a warning about unmatched SMF id
                                //Reference id &quot;{0}&quot; for column &quot;{1}&quot; from element &quot;{2}&quot; in section &quot;{3}&quot; to section &quot;{4}&quot; must have a matching element defined.
<span class="nc" id="L605">                                errorList.add(new MZTabError(</span>
                                    LogicalErrorType.UnknownRefId, -1,
                                    &quot;&quot; + smeRefId,
                                    SmallMoleculeFeature.Properties.smeIdRefs.
<span class="nc" id="L609">                                        getPropertyName(), &quot;&quot; + smf.getSmfId(),</span>
                                    MzTab.Properties.smallMoleculeFeature.
<span class="nc" id="L611">                                        getPropertyName(),</span>
                                    MzTab.Properties.smallMoleculeEvidence.
<span class="nc" id="L613">                                        getPropertyName()));</span>
<span class="nc" id="L614">                            }</span>
                        }
<span class="fc" id="L616">                    }</span>
                }
            }
        }

<span class="fc" id="L621">    }</span>

    protected void checkColunitMapping(MZTabColumnFactory columnFactory,
        Optional&lt;Collection&lt;ColumnParameterMapping&gt;&gt; columnParameterMapping,
        Metadata.Properties colUnitProperty, MzTab.Properties mzTabSection) {
<span class="fc" id="L626">        columnParameterMapping.orElse(Collections.emptyList()).</span>
<span class="fc" id="L627">            forEach((colUnit) -&gt;</span>
            {
<span class="fc" id="L629">                String columnName = colUnit.getColumnName();</span>
<span class="fc" id="L630">                IMZTabColumn column = columnFactory.findColumnByHeader(</span>
                    columnName);
<span class="fc bfc" id="L632" title="All 2 branches covered.">                if (column == null) {</span>
<span class="fc" id="L633">                    errorList.add(new MZTabError(</span>
                        FormatErrorType.ColUnit, -1,
                        colUnitProperty.
<span class="fc" id="L636">                            getPropertyName(), columnName,</span>
                        mzTabSection.
<span class="fc" id="L638">                            getPropertyName()));</span>
                }
<span class="fc" id="L640">            });</span>
<span class="fc" id="L641">    }</span>

    /**
     * &lt;p&gt;
     * getMZTabFile.&lt;/p&gt;
     *
     * @return a {@link de.isas.mztab2.model.MzTab} object.
     */
    public MzTab getMZTabFile() {
<span class="fc" id="L650">        return mzTabFile;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>